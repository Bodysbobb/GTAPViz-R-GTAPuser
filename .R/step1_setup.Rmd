---
title: "Step 1: Project Setup"
output: html_document
site: rmarkdown::render_site
---

```{r render, eval=FALSE, include=FALSE}
# build_docs.R

# 1. Render the R Markdown website to the default output_dir (e.g., "docs")
rmarkdown::render_site(input = ".", encoding = "UTF-8")

# 2. Define destination path (change this to your OneDrive path)
destination_path <- "D:/One Drive/OneDrive - purdue.edu/JGEA Paper/GTAPViz/users/src/!README"

# 3. Copy all rendered files from "docs/" to your internal directory
dir.create(destination_path, recursive = TRUE, showWarnings = FALSE)
file.copy(
  from = list.files("docs", full.names = TRUE),
  to   = destination_path,
  overwrite = TRUE,
  recursive = TRUE
)

message("âœ… Rendered and copied to both GitHub and internal folder.")

```


This manual provides an explanation of the file `1.ProjectSetup.R`


<div style="height: 6px;"></div>

# Directories and Input Files {.unnumbered}

Before proceeding, make sure your project directory is structured as follows:

1. Replace all sample input files in the `/in` folder with your own simulation results.

2. Ensure that `OutputMapping.xlsx` exists in the `/map` folder and that you have defined the parameters you want to extract:

   - Use the `SL4File` sheet to select variables from the `.sl4` file.  
   - Use the `HARFile` sheet to select variables from the `.har` file.  
   - The `Filter` sheet (optional) allows you to:
     - Use the `Region` column to specify regions (default GTAP column: `REG`).
     - Use the `Sector` column to specify sectors (default GTAP columns: `COMM` and `ACTS`).

**Note:** If `OutputMapping.xlsx` is missing, you can download it again from [here](https://github.com/Bodysbobb/GTAPViz/tree/main/inst/extdata/map).


<figure class="center-figure">
<div class="folder-tree">
```{.monospace}
ðŸ“‚ project.folder/
â”œâ”€â”€ ðŸ“‚ in/
â”‚   â”œâ”€â”€ ðŸ“„ IncreaseTar10.sl4
â”‚   â”œâ”€â”€ ðŸ“„ IncreaseTar10-WEL.har
â”‚   â”œâ”€â”€ ðŸ“„ IncreaseTar50.sl4
â”‚   â”œâ”€â”€ ðŸ“„ IncreaseTar50-WEL.har
â”‚   â”œâ”€â”€ ðŸ“„ ...
â”œâ”€â”€ ðŸ“‚ map/
â”‚   â”œâ”€â”€ ðŸ“„ OutputMapping.xlsx
â”œâ”€â”€ ðŸ“‚ out/
```
</div> 
<figcaption class="auto-fig">Example of Project Folder</figcaption> </figure>


# Project Parameters

## `project.folder` 

R requires forward slashes (`/`) in the file path.

```{r, eval=FALSE}
project.folder <- "c:/your/project/folder"
```

<div style="height: 8px;"></div>

## `experiment` 

List all input file names (`.sl4` and/or `.har`) **without suffix**, located in the **/in** folder, in the desired order:

<details>
  <summary class="toggle-note">Explanations</summary>
  <div class="note-box">
**Note**: <br>
(1) **Case-sensitive** â€” `"Exp1"` is different from `"exp1"`  
(2) **Display order matters** â€” files listed first will appear first in outputs and figures  
(3) **Matching names required** â€” simulations must use the same base name for both `.sl4` and `.har` files to align results correctly (e.g., `IncreaseTar10.sl4` and `IncreaseTar10.har`)
  </div>
</details>


```{r, eval=FALSE}
experiment <- c("IncreaseTar10", "IncreaseTar50", "ReduceTar20")
```

<div style="height: 8px;"></div>

## `sl4_suffix / har_suffix`

This is the suffix used in the file name (not the file extension). Use `NULL` or `""` if no suffix is used.

```{r, eval=FALSE}
sl4_suffix <- ""
har_suffix <- "-WEL"
```

## `process_var`

Define which variables to process for `sl4` and `har` separately.  

<details>
  <summary class="toggle-note">Explanations</summary>
  <div class="note-box">
By default, the setup follows your mapping file sheets "SL4File" and "HARFile".<br>
- `sl4map` and `harmap`: Default mode<br>
- `NULL`: Select all variables from that file format<br>
- `FALSE`: Skipping that file format
  </div>
</details>

```{r, eval=FALSE}
process_sl4_vars <- "sl4map"  # Leave it like this for default
process_har_vars <- "harmap"  # Leave it like this for default
```


# Output Formatting Parameters

## `mapping_info`

<details>
  <summary class="toggle-note">Explanations</summary>
<div class="note-box">
  
- `"Yes"`   â†’ Uses descriptions and units from the mapping file.  

- `"No"`    â†’ Excludes `"Description"` and `"Unit"`.  

- `"GTAPv7"`â†’ Applies default definitions and units from *GTAP Model Version 7*.  

- `"Mix"`   â†’ Uses manual values when available; otherwise, applies GTAP defaults.  

See details in `GTAPViz::?add_mapping_info`
</div>
</details>

```{r, eval=FALSE}
mapping_info <- "Mix"        
```

<div style="height: 8px;"></div>

## `output formats`

**"Yes" or "No"**. Available formats: .csv, .dta (Stata), .Rds (R), .txt
```{r, eval=FALSE}
csv.output <- "No"    
stata.output <- "No"  
r.output <- "No"
txt.output <- "No"   
```

<div style="height: 8px;"></div>

## `plot_data` 

**TRUE / FASLE**. This will be used for plotting and generating tables in Step 2 and Step 3.
```{r, eval=FALSE}
plot_data <- TRUE
```

<div style="height: 8px;"></div>

## `convert_unit / decimals` 

This setting applies unit conversion to all input files matching the specified unit values.

<details>
  <summary class="toggle-note">Explanations</summary>
<div class="note-box">

The default `"Unit"` is based on your mapping file or `"GTAPv7"`, depending on the `mapping_info` setting.

- `"mil2bil"`: million â†’ billion USD (/1000)

- `"bil2mil"`: billion â†’ million USD (*1000) 

- `"pct2frac"`: percent â†’ fraction (/100)  

- `"frac2pct"`: fraction â†’ percent (*100)

See details in `?convert_units` under `scale_auto`
</div>
</details>

```{r, eval=FALSE}
sl4_convert_unit <- c("mil2bil")   # Use NULL for no unit conversion
har_convert_unit <- c("mil2bil", "pct2frac")
decimals <- 4
```

<div style="height: 8px;"></div>

## `rename_columns`

Renames GTAP column identifiers (`TRUE` or `FALSE`) to more readable format  for all data extraction methods.

<details>
  <summary class="toggle-note">Explanations</summary>
<div class="note-box">

- `REG` â†’ Region,

- `COMM` â†’ Commodity, 

- `ACTS` â†’ Activity

**Note:**
This setup will only work with those three columns, if you desire to rename additional columns see **FAQs - Renaming Columns and Data List Names"**

</div>
</details>

```{r, eval=FALSE}
rename_columns <- TRUE
```

<div style="height: 6px;"></div>

## `subtotal_level`

Set `TRUE` if subtotals are included in your simulations

```{r, eval=FALSE}
subtotal_level <- FALSE
```

## `add_scenario_ranking`

Options: `TRUE`, `FALSE`, or `"merged"`

<details>
  <summary class="toggle-note">Explanations</summary>
<div class="note-box">

- `TRUE`: Adds a ranking column called `"ScenarioRank"`

- `"merged"`: Also prefixes experiment names in the `"Experiment"` column with the rank (e.g., `(1) ReduceTar50`) for display in plots

</div>
</details>
```{r, eval=FALSE}
add_scenario_ranking <- TRUE
```


# (Optional) Auto GTAP Data Extraction {.unnumbered}

If you want to **manually set up the initial GTAP data** or **recover after deleting the setup file**,  
you can copy and paste the following code into your R script to retrieve the required data:

<details>
  <summary class="toggle-summary">ðŸ’» AutoGTAP Codes</summary>
```{=html}
<!-- START: AutoGTAP Filter UI -->
<style>
  label { font-weight: bold; }
  select { font-size: 16px; margin-bottom: 20px; padding: 5px 10px; width: 300px;}
  pre { background-color: #f4f4f4; padding: 15px; border-left: 5px solid #1C3E5D; overflow-x: auto; }
  .code-box { display: none; }
</style>

<label for="AutoGTAPData">Choose Codes:</label>
<select id="AutoGTAPData">
  <option value="default">Default</option>
  <option value="advanced">Advanced</option>
WT</select>

<div class="code-group-AutoGTAP">

<div id="default" class="code-box">
<p>This function is a default <code>auto_gtap_data</code> applied in default setup of <code>1.ProjectSetup.R</code> </p>

<pre><code>
# Directory Setup and Input Files
project.folder <- "your/project.directory"  # Use forward slashes (/)
experiment <- c("IncreaseTar10", "IncreaseTar50", "ReduceTar20")  # Replace with your case names
sl4_suffix <- ""       # Suffix for .sl4 files (leave empty or NULL if none)
har_suffix <- "-WEL"   # Suffix for .har files
process_sl4_vars <- "sl4map"  # Leave it like this for default
process_har_vars <- "harmap"  # Leave it like this for default
subtotal_level <- FALSE  # Set TRUE if subtotals are included in your simulations

# Meta Data
mapping_info <- "Mix"  # Controls variable descriptions and units (see documentation)

# Output Format Setup
csv.output   <- "No"
stata.output <- "No"
r.output     <- "No"
txt.output   <- "No"
plot_data    <- TRUE   # Generate plot-ready outputs

# Output Formatting
sl4_convert_unit <- "mil2bil"  # Convert million to billion
har_convert_unit <- "mil2bil"
decimals         <- 2
rename_columns   <- TRUE       # Rename GTAP columns (e.g., "REG" â†’ "Region")
add_scenario_ranking <- TRUE   # Add numeric rank to experiments

###################################
# DO NOT CHANGE BELOW THIS LINE
###################################

assign_default <- function(var_name, default_value, treat_null_as_missing = TRUE, treat_empty_string_as_missing = FALSE) {
  if (!exists(var_name)) {
    return(default_value)
  }
  
  val <- get(var_name)
  
  if (is.na(val)) return(default_value)
  if (treat_null_as_missing && is.null(val)) return(default_value)
  if (treat_empty_string_as_missing && identical(val, "")) return(default_value)
  
  return(val)
}

# Install packagfees if not already installed
if (!requireNamespace("devtools", quietly = TRUE)) {
  install.packages("devtools")
}

# Install GTAPViz from GitHub if not already installed
if (!requireNamespace("GTAPViz", quietly = TRUE)) {
  devtools::install_github("Bodysbobb/GTAPViz")
}

# Load the GTAPViz package
require(GTAPViz)

# 1. Default Directory
input.folder <- paste0(project.folder, "/in")
map.folder <- paste0(project.folder, "/map")
output.folder <- paste0(project.folder, "/out")

# 2. Default Input Files
sl4map <- readxl::read_xlsx(paste0(map.folder, "/OutputMapping.xlsx"), sheet = "SL4File")
harmap <- readxl::read_xlsx(paste0(map.folder, "/OutputMapping.xlsx"), sheet = "HARFile")
filter.map <- readxl::read_xlsx(paste0(map.folder, "/OutputMapping.xlsx"), sheet = "FilterData")

# 3. Suffix for Input Files
sl4_suffix <- assign_default("sl4_suffix", "", treat_empty_string_as_missing = FALSE)
har_suffix <- assign_default("har_suffix", "", treat_empty_string_as_missing = FALSE)

# 4. Filter Data
selected_regions <- if (exists("filter.map") && length(filter.map$Region) > 0) filter.map$Region else NULL
selected_sector  <- if (exists("filter.map") && length(filter.map$Sector) > 0) filter.map$Sector else NULL

# 5. Converting Units & Rename Columns
sl4_convert_unit <- assign_default("sl4_convert_unit", NULL)
har_convert_unit <- assign_default("har_convert_unit", NULL)
decimals <- assign_default("decimals", 4)
rename_columns <- assign_default("rename_columns", TRUE)

# 6. Scenario Number Labels Column
add_scenario_ranking <- assign_default("add_scenario_ranking", FALSE)

# 7. Data Extraction Methods
## Set default values if missing
sl4_extract_method <- assign_default("sl4_extract_method", "get_data_by_dims")
har_extract_method <- assign_default("har_extract_method", "get_data_by_var")

## Check if priority is missing when using group_data_by_dims
if (sl4_extract_method == "group_data_by_dims") {
  if (!exists("sl4_priority") || is.null(sl4_priority) || sl4_priority == "") {
    stop("Please define 'sl4_priority' for sl4_extract_method = 'group_data_by_dims'")
  }
}

if (har_extract_method == "group_data_by_dims") {
  if (!exists("har_priority") || is.null(har_priority) || har_priority == "") {
    stop("Please define 'har_priority' for har_extract_method = 'group_data_by_dims'")
  }
}

auto_gtap_data(
  # Input Main File Names
  experiment = experiment, 
  
  # Input File Suffixes
  sl4_suffix = sl4_suffix,
  har_suffix = har_suffix,
  
  # Directories
  input_path = input.folder,
  output_path = output.folder,
  
  # Variable Selection
  process_sl4_vars = sl4map, 
  process_har_vars = harmap,
  
  # Description and Unit Mapping (if `mapping_info` is set to "Yes" or "Mix")
  mapping_info = mapping_info,
  sl4_mapping_info = sl4map,
  har_mapping_info = harmap,
  rename_columns = rename_columns,
  
  # Convert units (see `?convert_units`)
  sl4_convert_unit = sl4_convert_unit,
  har_convert_unit = har_convert_unit,
  
  # Region and Sector Filtering
  region_select = selected_regions,
  sector_select = selected_sector,
  
  # Data Extraction Process
  sl4_extract_method = sl4_extract_method,
  har_extract_method = har_extract_method,
  subtotal_level = subtotal_level,
  
  # If using `"group_data_by_dims"`, a `priority_list` is required. See `?HARplus::group_data_by_dims`.
  sl4_priority = sl4_priority,
  har_priority = har_priority,
  
  # Adding Scenario Ranking
  add_scenario_ranking = add_scenario_ranking,
  
  # Output Formats
  plot_data = plot_data,
  output_formats = list(
    "csv" = csv.output,
    "stata" = stata.output,
    "rds" = r.output,
    "txt" = txt.output
  ),
  
  # Output Names for Plot Data
  sl4_output_name = "sl4.plot.data",
  har_output_name = "har.plot.data",
  macro_output_name = "GTAPMacro"
)
</code></pre>
</div>

<div id="advanced" class="code-box">
  <p>This function is an advanced mode for fully configuring everything within the function itself.  
<strong>You must define all parameters manually. See <code>?auto_gtap_data</code> for details.</strong></p>
  
  <pre><code>
# See ?auto_gtap_data

auto_gtap_data(
  # Input Main File Names
  experiment = experiment, 
  
  # Input File Suffixes
  sl4_suffix = sl4_suffix,
  har_suffix = har_suffix,
  
  # Directories
  input_path = input.folder,
  output_path = output.folder,
  
  # Variable Selection
  process_sl4_vars = sl4map, 
  process_har_vars = harmap,
  
  # Description and Unit Mapping (if `mapping_info` is set to "Yes" or "Mix")
  mapping_info = mapping_info,
  sl4_mapping_info = sl4map,
  har_mapping_info = harmap,
  rename_columns = rename_columns,
  
  # Convert units (see `?convert_units`)
  sl4_convert_unit = sl4_convert_unit,
  har_convert_unit = har_convert_unit,
  
  # Region and Sector Filtering
  region_select = selected_regions,
  sector_select = selected_sector,
  
  # Data Extraction Process
  sl4_extract_method = sl4_extract_method,
  har_extract_method = har_extract_method,
  subtotal_level = subtotal_level,
  
  # If using `"group_data_by_dims"`, a `priority_list` is required. See `?HARplus::group_data_by_dims`.
  sl4_priority = sl4_priority,
  har_priority = har_priority,
  
  # Adding Scenario Ranking
  add_scenario_ranking = add_scenario_ranking,
  
  # Output Formats
  plot_data = plot_data,
  output_formats = list(
    "csv" = csv.output,
    "stata" = stata.output,
    "rds" = r.output,
    "txt" = txt.output
  ),
  
  # Output Names for Plot Data
  sl4_output_name = "sl4.plot.data",
  har_output_name = "har.plot.data",
  macro_output_name = "GTAPMacro"
)
  </code></pre>
</div>

</div>

<script>
  const selectAutoGTAP = document.getElementById("AutoGTAPData");
  const boxesComparison = document.querySelectorAll(".code-group-AutoGTAP .code-box");

  function showAutoGTAP() {
    boxesComparison.forEach(box => box.style.display = "none");
    const selected = selectAutoGTAP.value;
    const box = document.getElementById(selected);
    if (box) box.style.display = "block";
  }

  selectAutoGTAP.addEventListener("change", showAutoGTAP);
  showAutoGTAP();
</script>
<!-- END -->
```
</details>


```{=html}
<script>
// SCRIPT 1: Copy Code Button
window.addEventListener("load", function () {
  document.querySelectorAll("pre code").forEach(function (codeBlock) {
    const button = document.createElement("button");
    button.className = "copy-code-button";
    button.type = "button";
    button.innerText = "Copy";
    button.style.position = "absolute";
    button.style.top = "4px";
    button.style.right = "4px";

    button.addEventListener("click", () => {
      navigator.clipboard.writeText(codeBlock.innerText).then(() => {
        button.innerText = "Copied!";
        button.classList.add("copied");
        setTimeout(() => {
          button.innerText = "Copy";
          button.classList.remove("copied");
        }, 1500);
      });
    });

    const pre = codeBlock.parentNode;
    pre.style.position = "relative";
    pre.insertBefore(button, codeBlock);
  });
});

// SCRIPT 2: Hide Navbar on Scroll Down
document.addEventListener("DOMContentLoaded", function () {
  let prevScrollPos = window.pageYOffset;
  const navbar = document.querySelector(".navbar");
  
  if (navbar) {
    // Set initial styles for smooth transition
    navbar.style.transition = "top 0.3s";
    navbar.style.position = "fixed";
    navbar.style.width = "100%";
    navbar.style.zIndex = "1000";
    
    window.addEventListener("scroll", function () {
      const currentScrollPos = window.pageYOffset;
      if (prevScrollPos > currentScrollPos) {
        // Scrolling up
        navbar.style.top = "0";
      } else {
        // Scrolling down
        navbar.style.top = "-70px";
      }
      prevScrollPos = currentScrollPos;
    });
  }
});

// SCRIPT 3: Center Navbar Items
document.addEventListener('DOMContentLoaded', function() {
  // Create a container to center the navbar items
  var navbar = document.querySelector('.navbar-collapse');
  var navLinks = document.querySelectorAll('.navbar-left li');
  var navRight = document.querySelector('.navbar-right');
  
  // Apply styles to center the main navigation
  if (navbar && navLinks.length > 0) {
    var mainNav = document.querySelector('.navbar-left');
    
    // Add a wrapper div to center the main nav
    var centerWrapper = document.createElement('div');
    centerWrapper.className = 'nav-center-wrapper';
    centerWrapper.style.display = 'flex';
    centerWrapper.style.justifyContent = 'center';
    centerWrapper.style.flex = '1';
    
    // Move the main navbar inside this wrapper
    if (mainNav && mainNav.parentNode) {
      mainNav.parentNode.insertBefore(centerWrapper, mainNav);
      centerWrapper.appendChild(mainNav);
    }
  }
});
</script>
```
