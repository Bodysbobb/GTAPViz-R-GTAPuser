---
title: "Step 3: Table Configurations"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
```

This manual provides an explanation of the file `3.TableGens.R`

<div class="info-box">
  <strong>‚ùó Important:</strong>
  <ul style="margin-top: 8px; padding-left: 20px;">
    <li>You must run <code>1.ProjectSetup</code> with <code>plot_data &lt;- TRUE</code> before running this script.</li>
    <li>You can simply copy and paste any table code from this manuscript and replace the original code in <code>3.TableGens.R</code>.</li>
  </ul>
</div>


# Table Types {.unnumbered}

If you are unsure, please refer to: [Table Catalogs](https://pattawee.shinyapps.io/gtapviz-advanced-table-configs/)


You may define a custom output folder to create separate directories for each plot.

```{r, eval=FALSE}
# Define new output location (or leave it as deafult)
output.folder <- output.folder
```


# Report Table

## Input (`data_list`)

For this table, **a data list** is required, this data definition should match the output in `sl4.plot.data` and `har.plot.data`.

- This is different to the data used in plotting, which is a **data frame**.

- Multiple tables based on a single data list can be created in one setup (e.g., **all data frames within `sl4.plot.data` can be generated in a single code block**).

```{r, eval=FALSE}
data_list <- sl4.plot.data   

# However, if you used "group_data_by_dims", you may need to de-list one level as follows:
# data_list <- sl4.plot.data[["Sector"]]
```

## Key Table Parameters

<details>
  <summary class="toggle-summary"><code>(1) pivot_col</code></summary>
  
Define the pivot column for each dataframe within the data list. For example,
 
 - `REG` and `COMM*REG` are dataframes within `sl4.plot.data`,  
 
 - `Variable` and `Commodity` are the columns to be pivoted in each respective dataframe  


```{r, eval=FALSE}
pivot_col = list( # DO NOT CHANGE THIS LIST LINE; MAKE YOUR CHANGES BELOW
  REG = "Variable", 
  COMM*REG = "Commodity"
) # DO NOT REMOVE THIS BRACKET
```

</details>

<br>

<details>
  <summary class="toggle-summary"><code>(2) group_by</code></summary>

Define the main group columns (used as rows in the structured table) for each dataframe. The order matters: the first listed will be shown as the first (leftmost) column  

```{r, eval=FALSE}
group_by = list( # DO NOT CHANGE THIS LIST LINE; MAKE YOUR CHANGES BELOW
  REG = list("Experiment", "Region"),
  COMM*REG = list("Experiment", "Variable", "Region")
) # DO NOT REMOVE THIS BRACKET
```

</details>

<br>

<details>
  <summary class="toggle-summary"><code>(3) configs</code></summary>
  
```{r, eval = FALSE}
rename_cols       = list("Experiment" = "Scenario"),  # Rename "Experiment" to "Scenario"
total_column      = FALSE,  # Add row totals (e.g., for decomposition)
decimal           = 4,      # Number of decimal places
subtotal_level    = FALSE,  # Include subtotal rows from CGE if available
repeat_label      = FALSE,  # Repeat group labels in all rows
include_units     = TRUE,   # Append unit to column names (e.g., (%), (million USD))

var_name_by_description = TRUE,  # Use variable description instead of GTAP code
add_var_info            = TRUE,  # Append code or description in parentheses
add_group_line          = FALSE, # Add line between groups based on first column

separate_sheet_by = "Unit",          # Split sheets by this column
export_table      = TRUE,            # Export to Excel
output_path       = output.folder,   # Output directory
separate_file     = FALSE,           # Split sheets into separate workbooks
workbook_name     = "Comparison Table 1D"  # Workbook file name
```
</details>

<br>

## Report Table Codes

<details>
  <summary class="toggle-summary">üíª Report Table Codes</summary>
```{=html}
<!-- START: Report Table Filter UI -->
<style>
  label { font-weight: bold; }
  select { font-size: 16px; margin-bottom: 20px; padding: 5px 10px; width: 300px;}
  pre { background-color: #f4f4f4; padding: 15px; border-left: 5px solid #1C3E5D; overflow-x: auto; }
  .code-box { display: none; }
</style>

<label for="tableFilter">Choose Report Table Example:</label>
<select id="tableFilter">
  <option value="report_default">Default</option>
  <option value="report_1d">One-dimensional Structure</option>
  <option value="report_2d">Two-dimensional Structure</option>
  <option value="report_3d">Three-dimensional Structure</option>
</select>

<div class="report-code-blocks">

<div id="report_default" class="code-box">
<p>A default code provided in `3.TableGens.R`.</p>
<pre><code>
# Your data list
data_list <- sl4.plot.data

report_table(
  data_list = data_list,
  pivot_col = list( # See manual or run `?report_table` for more details
    REG = "Variable", 
    'COMM*REG' = "Commodity"
  ),
  group_by = list( # See manual or run `?report_table` for more details
    REG = list("Experiment", "Region"),
    'COMM*REG' = list("Experiment", "Variable", "Region")
  ),

  rename_cols = list("Experiment" = "Scenario"), 
  total_column = FALSE,
  decimal = 4,
  subtotal_level = FALSE,
  repeat_label = FALSE,
  include_units = TRUE,
  
  var_name_by_description = TRUE,
  add_var_info = TRUE,
  add_group_line = FALSE,
  
  separate_sheet_by = "Unit",
  export_table = TRUE,
  output_path = output.folder,
  separate_file = FALSE,
  workbook_name = "Comparison Table Default"
)
</code></pre>
</div>


<div id="report_1d" class="code-box">
<p>A one-dimensional structure groups data by a single dimension, such as <code>REG</code>, <code>COMM</code>, or <code>ACTS</code>.</p>
<pre><code>
# Your data list
data_list <- sl4.plot.data

report_table(
  data_list = data_list,
  pivot_col = list( # See manual or run `?report_table` for more details
  REG = "Variable"
  ),
  group_by = list( # See manual or run `?report_table` for more details
    REG = list("Experiment", "Region")
    ),
    
  rename_cols = list("Experiment" = "Scenario"),
  total_column = FALSE,
  decimal = 4,
  subtotal_level = FALSE,
  repeat_label = FALSE,
  include_units = TRUE,

  var_name_by_description = TRUE,
  add_var_info = TRUE,
  add_group_line = FALSE,
  
  separate_sheet_by = "Unit",
  export_table = TRUE,
  output_path = output.folder,
  separate_file = FALSE,
  workbook_name = "Comparison Table 1D"
)
</code></pre>
</div>

<div id="report_2d" class="code-box">
<p>A two-dimensional structure groups data by two dimensions, such as <code>REG*COMM</code> or <code>REG*ACTS</code>.</p>
<pre><code>
# Your data list
data_list <- sl4.plot.data

report_table(
  data_list = data_list,
  pivot_col = list( # See manual or run `?report_table` for more details
    COMM*REG = "Commodity"
  ),
  
  group_by = list( # See manual or run `?report_table` for more details
    COMM*REG = list("Experiment", "Variable", "Region")
  ),

  rename_cols = list("Experiment" = "Scenario"), 
  total_column = FALSE,
  decimal = 4,
  subtotal_level = FALSE,
  repeat_label = FALSE,
  include_units = TRUE,
  
  var_name_by_description = TRUE,
  add_var_info = TRUE,
  add_group_line = FALSE,
  
  separate_sheet_by = "Unit",
  export_table = TRUE,
  output_path = output.folder,
  separate_file = FALSE,
  workbook_name = "Comparison Table 2D"
)
</code></pre>
</div>

<div id="report_3d" class="code-box">
<p>A multi-dimensional structure groups data by more than two dimensions, such as <code>COMM*REG*REG</code> for bilateral trade at the sector level.</p>
<pre><code>
# Your data list
data_list <- bilateral_data

report_table( 
  data_list = bilateral_data,
  pivot_col = list( # See manual or run `?report_table` for more details
  qxs = "Commodity"
  ),
  
  group_by = list( # See manual or run `?report_table` for more details
    qxs = list("Experiment", "Source", "Destination")
    ),
    
  rename_cols = list("Experiment" = "Scenario"),
  total_column = FALSE,
  decimal = 4,
  subtotal_level = FALSE,
  repeat_label = FALSE,
  include_units = TRUE,

  var_name_by_description = TRUE,
  add_var_info = TRUE,
  add_group_line = TRUE,
  
  separate_sheet_by = "Unit",
  export_table = TRUE,
  output_path = output.folder,
  separate_file = FALSE,
  workbook_name = "Comparison Table 3D"
)
</code></pre>
</div>

</div> <!-- END .report-code-blocks wrapper -->

<script>
  const tableSelect = document.getElementById("tableFilter");
  const tableWrapper = document.querySelector(".report-code-blocks");
  const tableBoxes = tableWrapper.querySelectorAll(".code-box");

  function showTableBox() {
    tableBoxes.forEach(box => box.style.display = "none");
    const selected = tableSelect.value;
    const target = document.getElementById(selected);
    if (target) target.style.display = "block";
  }

  tableSelect.addEventListener("change", showTableBox);
  showTableBox();
</script>

```
</details>



# Pivot Table with Filter

This pivot table requires **a data frame** similar to the one used for plotting. Therefore, you can create **only one table per setup**‚Äîunlike structured tables, which support multiple tables within a single setup.

<details>
  <summary class="toggle-summary">üíª Pivot Table with Filter Codes</summary>
```{=html}
<!-- START: Pivot Table Filter UI -->
<style>
  label { font-weight: bold; }
  select { font-size: 16px; margin-bottom: 20px; padding: 5px 10px; width: 300px;}
  pre { background-color: #f4f4f4; padding: 15px; border-left: 5px solid #1C3E5D; overflow-x: auto; }
  .code-box { display: none; }
</style>

<label for="pivotFilter">Choose Pivot Table Structure:</label>
<select id="pivotFilter">
  <option value="pivot_default">Default</option>
  <option value="pivot_multi">Multiple-filter Structure</option>
</select>

<div class="pivot-code-blocks">

<div id="pivot_default" class="code-box">
<p>A default code provided in `3.TableGens.R`.</p>

<pre><code>
# Your data frame
data_pivot_table <- sl4.plot.data[["REG"]] 

pivot_table_with_filter( # DO NOT CHANGE THIS FUCNTION NAME; MAKE YOUR CHANGES BELOW
  data = data_pivot_table,
  filter = c("Variable", "Unit"),    # Allow filtering by variable type and unit
  rows = c("Region", "Sector"),      # Regions and sectors as row fields
  cols = c("Experiment"),           # Experiments as column fields
  data_fields = "Value",            # Values to be aggregated
  raw_sheet_name = "Raw_Data",     # Sheet name for raw data
  pivot_sheet_name = "Sector_Pivot", # Sheet name for pivot table
  dims = "A3",                      # Starting cell for pivot table
  export = TRUE,
  output_path = output.folder,
  workbook_name = "Sectoral_Impact_Analysis.xlsx"
)
</code></pre>
</div>


<div id="pivot_multi" class="code-box">
<pre><code>
# Your data frame
data_pivot_table <- bilateral_data[["qxs"]] 

pivot_table_with_filter( # DO NOT CHANGE THIS FUCNTION NAME; MAKE YOUR CHANGES BELOW
  data = data_pivot_table,
  filter = c("Experiment", "Commodity", "Unit"),    # Allow filtering by variable type and unit
  rows = c("Source"),      # Regions and sectors as row fields
  cols = c("Destination"),           # Experiments as column fields
  data_fields = "Value",            # Values to be aggregated
  raw_sheet_name = "Raw_Data",     # Sheet name for raw data
  pivot_sheet_name = "Sector_Pivot", # Sheet name for pivot table
  dims = "A5",                      # Starting cell for pivot table
  export = TRUE,
  output_path = output.folder,
  workbook_name = "Sectoral_Impact_Analysis.xlsx"
)
</code></pre>
</div>

</div>

</div> <!-- END .pivot-code-blocks wrapper -->

<script>
  const pivotSelect = document.getElementById("pivotFilter");
  const pivotWrapper = document.querySelector(".pivot-code-blocks");
  const pivotBoxes = pivotWrapper.querySelectorAll(".code-box");

  function showPivotBox() {
    pivotBoxes.forEach(box => box.style.display = "none");
    const selected = pivotSelect.value;
    const target = document.getElementById(selected);
    if (target) target.style.display = "block";
  }

  pivotSelect.addEventListener("change", showPivotBox);
  showPivotBox();
</script>
```
</details>

```{=html}
<script>
// SCRIPT 1: Copy Code Button
window.addEventListener("load", function () {
  document.querySelectorAll("pre code").forEach(function (codeBlock) {
    const button = document.createElement("button");
    button.className = "copy-code-button";
    button.type = "button";
    button.innerText = "Copy";
    button.style.position = "absolute";
    button.style.top = "4px";
    button.style.right = "4px";
    button.addEventListener("click", () => {
      navigator.clipboard.writeText(codeBlock.innerText).then(() => {
        button.innerText = "Copied!";
        setTimeout(() => (button.innerText = "Copy"), 1500);
      });
    });
    const pre = codeBlock.parentNode;
    pre.style.position = "relative";
    pre.insertBefore(button, codeBlock);
  });
});

// SCRIPT 2: Hide Navbar on Scroll Down
document.addEventListener("DOMContentLoaded", function () {
  let prevScrollPos = window.pageYOffset;
  const navbar = document.querySelector(".navbar");
  
  if (navbar) {
    // Set initial styles for smooth transition
    navbar.style.transition = "top 0.3s";
    navbar.style.position = "fixed";
    navbar.style.width = "100%";
    navbar.style.zIndex = "1000";
    
    window.addEventListener("scroll", function () {
      const currentScrollPos = window.pageYOffset;
      if (prevScrollPos > currentScrollPos) {
        // Scrolling up
        navbar.style.top = "0";
      } else {
        // Scrolling down
        navbar.style.top = "-70px";
      }
      prevScrollPos = currentScrollPos;
    });
  }
});

// SCRIPT 3: Center Navbar Items
document.addEventListener('DOMContentLoaded', function() {
  // Create a container to center the navbar items
  var navbar = document.querySelector('.navbar-collapse');
  var navLinks = document.querySelectorAll('.navbar-left li');
  var navRight = document.querySelector('.navbar-right');
  
  // Apply styles to center the main navigation
  if (navbar && navLinks.length > 0) {
    var mainNav = document.querySelector('.navbar-left');
    
    // Add a wrapper div to center the main nav
    var centerWrapper = document.createElement('div');
    centerWrapper.className = 'nav-center-wrapper';
    centerWrapper.style.display = 'flex';
    centerWrapper.style.justifyContent = 'center';
    centerWrapper.style.flex = '1';
    
    // Move the main navbar inside this wrapper
    if (mainNav && mainNav.parentNode) {
      mainNav.parentNode.insertBefore(centerWrapper, mainNav);
      centerWrapper.appendChild(mainNav);
    }
  }
});
</script>
```
